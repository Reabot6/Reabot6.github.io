<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyworldðŸ’œ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.1.0/cropper.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
    }

    #puzzle-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 80vh;
    }

    .puzzle-piece {
        border: 2px solid #333;
    }
</style>
</head>
<body>

<div class="container">
    <h1 class="text-center my-5">Upload Image and Solve the Puzzle</h1>
    <input type="file" id="file-input" class="form-control mb-3" accept="image/*">
    <div id="puzzle-container"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.1.0/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/konva@8.0.0/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shuffle-array/2.1.0/index.min.js"></script>
<script>
    const stage = new Konva.Stage({
        container: 'puzzle-container',
        width: 800,
        height: 600
    });

    const layer = new Konva.Layer();
    stage.add(layer);

    const fileInput = document.getElementById('file-input');

    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            if (!file.type.match('image.*')) {
                alert('Please upload an image file.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageSrc = e.target.result;
                createPuzzle(imageSrc);
            };
            reader.readAsDataURL(file);
        }
    });

    function createPuzzle(imageSrc) {
        layer.destroyChildren();

        const img = new Image();
        img.src = imageSrc;
        img.onload = function() {
            const pieceWidth = img.width / 4;
            const pieceHeight = img.height / 4;

            const pieces = [];
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const piece = new Konva.Image({
                        x: col * pieceWidth + Math.random() * 20 - 10,
                        y: row * pieceHeight + Math.random() * 20 - 10,
                        width: pieceWidth,
                        height: pieceHeight,
                        draggable: true,
                        image: img,
                        crop: {
                            x: col * pieceWidth,
                            y: row * pieceHeight,
                            width: pieceWidth,
                            height: pieceHeight
                        }
                    });
                    pieces.push(piece);
                    layer.add(piece);
                }
            }

            shuffleArray(pieces); // Shuffle pieces

            const boxes = [];
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    boxes.push({ x: col * pieceWidth, y: row * pieceHeight });
                }
            }

            pieces.forEach((piece, index) => {
                piece.on('dragend', () => {
                    const closestBox = findClosestBox(piece, boxes);
                    const tempX = piece.x();
                    const tempY = piece.y();
                    piece.position({ x: closestBox.x, y: closestBox.y });
                    boxes[index] = { x: tempX, y: tempY };
                    layer.batchDraw();
                    checkWin(pieces);
                });
            });

            layer.draw();
        };
    }

    function findClosestBox(piece, boxes) {
        let minDistance = Infinity;
        let closestBox = null;

        boxes.forEach(box => {
            const distance = Math.sqrt(Math.pow(piece.x() - box.x, 2) + Math.pow(piece.y() - box.y, 2));
            if (distance < minDistance) {
                minDistance = distance;
                closestBox = box;
            }
        });

        return closestBox;
    }

    function checkWin(pieces) {
        let win = true;
        pieces.forEach((piece, index) => {
            if (piece.x() !== index % 4 * piece.width() || piece.y() !== Math.floor(index / 4) * piece.height()) {
                win = false;
            }
        });
        if (win) {
            alert('Congratulations! You solved the puzzle!');
        }
    }
</script>

</body>
</html>
